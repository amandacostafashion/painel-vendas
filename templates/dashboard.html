<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Auto-refresh a cada 5 minutos (300s) -->
  <meta http-equiv="refresh" content="300">

  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">

    <!-- ===== HEADER ===== -->
    <header class="header">

      <div class="title-box">
        <h1 class="title-main">Acompanhamento de Vendas</h1>
        <div class="title-sub">Amanda Costa Fashion</div>
      </div>

      <form method="get" class="ref-form">
        <div class="ref-label">Data referência</div>

        <div class="ref-row">
          <input type="date" name="ref" value="{{ ref }}">
          <button class="btn">Aplicar</button>
        </div>
      </form>
    </header>

    {% if error %}
      <div class="alert">
        <strong>Erro:</strong> {{ error }}
        <div class="hint">
          Dica: confira os nomes das colunas <b>COL_DATA</b> e <b>COL_VALOR</b> no app.py.
        </div>
      </div>
    {% else %}

    <!-- ===== KPIs ===== -->
    <section class="grid">

      <!-- ================= CARD DIA ================= -->
      <div class="card">
        <div class="label">Venda do dia ({{ hoje_str }})</div>
        <div class="value">{{ v_hoje }}</div>

        <div class="meta">
          Dia anterior ({{ ontem_str }}): {{ v_ontem }}
          {% if pct_dia is not none %}
            <span class="pill {% if pct_dia >= 0 %}up{% else %}down{% endif %}">
              {{ "%.1f"|format(pct_dia) }}%
            </span>
          {% endif %}
        </div>

        <div class="meta">
          Mesmo dia do ano anterior ({{ ano_ant_str }}): {{ v_ano_ant }}
          {% if pct_ano is not none %}
            <span class="pill {% if pct_ano >= 0 %}up{% else %}down{% endif %}">
              {{ "%.1f"|format(pct_ano) }}%
            </span>
          {% endif %}
        </div>

        <div class="meta">
          Dia seguinte do ano anterior ({{ ano_ant_dia_seguinte_str }}):
          {{ v_ano_ant_dia_seguinte }}
          {% if pct_ano_dia_seguinte is not none %}
            <span class="pill {% if pct_ano_dia_seguinte >= 0 %}up{% else %}down{% endif %}">
              {{ "%.1f"|format(pct_ano_dia_seguinte) }}%
            </span>
          {% endif %}
        </div>
      </div>

      <!-- ================= CARD MÊS ================= -->
      <div class="card">
        <div class="label">
          Venda do mês ({{ ini_mes_str }} até {{ hoje_str }})
        </div>
        <div class="value">{{ v_mes_atual }}</div>

        <div class="meta">
          Mês anterior (mesmo período): {{ v_mes_ant }}
          {% if pct_mes is not none %}
            <span class="pill {% if pct_mes >= 0 %}up{% else %}down{% endif %}">
              {{ "%.1f"|format(pct_mes) }}%
            </span>
          {% endif %}
        </div>

        <!-- ✅ BLOCO CORRETO: MESMO MÊS DO ANO ANTERIOR -->
        <div class="meta">
          Mesmo mês do ano anterior ({{ mes_ano_ant_str }}): {{ v_mes_ano_ant }}
          {% if pct_mes_ano_ant is not none %}
            <span class="pill {% if pct_mes_ano_ant >= 0 %}up{% else %}down{% endif %}">
              {{ "%.1f"|format(pct_mes_ano_ant) }}%
            </span>
          {% endif %}
        </div>
      </div>

    </section>

    <!-- ===== TOP 5 DIAS ===== -->
    <section class="card mt">
      <div class="label">Top 5 dias do mês (por faturamento)</div>

      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th style="text-align:right;">Faturamento</th>
          </tr>
        </thead>
        <tbody>
          {% for r in top_dias %}
            <tr>
              <td>{{ r.data_fmt }}</td>
              <td style="text-align:right;">{{ r.valor_fmt }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- ===== TOP 5 CLIENTES ===== -->
    <section class="card mt">
      <div class="label">Top 5 clientes do mês (exceto Consumidor Final)</div>

      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th style="text-align:right;">Faturamento</th>
          </tr>
        </thead>
        <tbody>
          {% for r in top_clientes %}
            <tr>
              <td>{{ r["Cliente"] }}</td>
              <td style="text-align:right;">{{ r["valor_fmt"] }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    {% endif %}

  </div>
</body>
</html>
